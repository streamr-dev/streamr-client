!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define("streamr-client",[],t):"object"==typeof exports?exports["streamr-client"]=t():e.StreamrClient=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function n(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,s){n.o(e,t)||Object.defineProperty(e,t,{configurable:!1,enumerable:!0,get:s})},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=3)}([function(e,t,n){"use strict";var s=Object.prototype.hasOwnProperty,r="~";function o(){}function i(e,t,n,s,o){if("function"!=typeof n)throw new TypeError("The listener must be a function");var i=new function(e,t,n){this.fn=e,this.context=t,this.once=n||!1}(n,s||e,o),c=r?r+t:t;return e._events[c]?e._events[c].fn?e._events[c]=[e._events[c],i]:e._events[c].push(i):(e._events[c]=i,e._eventsCount++),e}function c(e,t){0==--e._eventsCount?e._events=new o:delete e._events[t]}function u(){this._events=new o,this._eventsCount=0}Object.create&&(o.prototype=Object.create(null),(new o).__proto__||(r=!1)),u.prototype.eventNames=function(){var e,t,n=[];if(0===this._eventsCount)return n;for(t in e=this._events)s.call(e,t)&&n.push(r?t.slice(1):t);return Object.getOwnPropertySymbols?n.concat(Object.getOwnPropertySymbols(e)):n},u.prototype.listeners=function(e){var t=r?r+e:e,n=this._events[t];if(!n)return[];if(n.fn)return[n.fn];for(var s=0,o=n.length,i=new Array(o);s<o;s++)i[s]=n[s].fn;return i},u.prototype.listenerCount=function(e){var t=r?r+e:e,n=this._events[t];return n?n.fn?1:n.length:0},u.prototype.emit=function(e,t,n,s,o,i){var c=r?r+e:e;if(!this._events[c])return!1;var u,a,f=this._events[c],l=arguments.length;if(f.fn){switch(f.once&&this.removeListener(e,f.fn,void 0,!0),l){case 1:return f.fn.call(f.context),!0;case 2:return f.fn.call(f.context,t),!0;case 3:return f.fn.call(f.context,t,n),!0;case 4:return f.fn.call(f.context,t,n,s),!0;case 5:return f.fn.call(f.context,t,n,s,o),!0;case 6:return f.fn.call(f.context,t,n,s,o,i),!0}for(a=1,u=new Array(l-1);a<l;a++)u[a-1]=arguments[a];f.fn.apply(f.context,u)}else{var d,b=f.length;for(a=0;a<b;a++)switch(f[a].once&&this.removeListener(e,f[a].fn,void 0,!0),l){case 1:f[a].fn.call(f[a].context);break;case 2:f[a].fn.call(f[a].context,t);break;case 3:f[a].fn.call(f[a].context,t,n);break;case 4:f[a].fn.call(f[a].context,t,n,s);break;default:if(!u)for(d=1,u=new Array(l-1);d<l;d++)u[d-1]=arguments[d];f[a].fn.apply(f[a].context,u)}}return!0},u.prototype.on=function(e,t,n){return i(this,e,t,n,!1)},u.prototype.once=function(e,t,n){return i(this,e,t,n,!0)},u.prototype.removeListener=function(e,t,n,s){var o=r?r+e:e;if(!this._events[o])return this;if(!t)return c(this,o),this;var i=this._events[o];if(i.fn)i.fn!==t||s&&!i.once||n&&i.context!==n||c(this,o);else{for(var u=0,a=[],f=i.length;u<f;u++)(i[u].fn!==t||s&&!i[u].once||n&&i[u].context!==n)&&a.push(i[u]);a.length?this._events[o]=1===a.length?a[0]:a:c(this,o)}return this},u.prototype.removeAllListeners=function(e){var t;return e?(t=r?r+e:e,this._events[t]&&c(this,t)):(this._events=new o,this._eventsCount=0),this},u.prototype.off=u.prototype.removeListener,u.prototype.addListener=u.prototype.on,u.prefixed=r,u.EventEmitter=u,e.exports=u},function(e,t,n){(function(s){function r(){var e;try{e=t.storage.debug}catch(e){}return!e&&void 0!==s&&"env"in s&&(e=s.env.DEBUG),e}(t=e.exports=n(6)).log=function(){return"object"==typeof console&&console.log&&Function.prototype.apply.call(console.log,console,arguments)},t.formatArgs=function(e){var n=this.useColors;if(e[0]=(n?"%c":"")+this.namespace+(n?" %c":" ")+e[0]+(n?"%c ":" ")+"+"+t.humanize(this.diff),!n)return;var s="color: "+this.color;e.splice(1,0,s,"color: inherit");var r=0,o=0;e[0].replace(/%[a-zA-Z%]/g,function(e){"%%"!==e&&"%c"===e&&(o=++r)}),e.splice(o,0,s)},t.save=function(e){try{null==e?t.storage.removeItem("debug"):t.storage.debug=e}catch(e){}},t.load=r,t.useColors=function(){if("undefined"!=typeof window&&window.process&&"renderer"===window.process.type)return!0;if("undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;return"undefined"!=typeof document&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||"undefined"!=typeof window&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/)&&parseInt(RegExp.$1,10)>=31||"undefined"!=typeof navigator&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)},t.storage="undefined"!=typeof chrome&&void 0!==chrome.storage?chrome.storage.local:function(){try{return window.localStorage}catch(e){}}(),t.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"],t.formatters.j=function(e){try{return JSON.stringify(e)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}},t.enable(r())}).call(t,n(5))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.decodeBrowserWrapper=function(e){var t=JSON.parse(e),n=t[0];if(0!==n)throw"Unknown message version: "+n;return{type:o[t[1]],subId:t[2],msg:t[3]}},t.decodeMessage=function(e,t){if("b"===e||"u"===e){if(void 0===r[t[0]])throw"Unsupported version: "+t[0];for(var n={},o=r[t[0]],i=0;i<t.length;i++){if("content"===o[i]){if(n.contentType!==s)throw"Unknown content type: "+n.contentType;t[i]=JSON.parse(t[i])}n[o[i]]=t[i]}return n}return t},t.createSubscribeRequest=function(e,t){var n={stream:e};return Object.keys(t).forEach(function(e){n[e]=t[e]}),n},t.isByeMessage=function(e){return!!e[i]};var s=27,r={28:["version","streamId","streamPartition","timestamp","ttl","offset","previousOffset","contentType","content"]},o=["b","u","subscribed","unsubscribed","resending","resent","no_resend"],i="_bye"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s,r=n(4),o=(s=r)&&s.__esModule?s:{default:s};t.default=o.default,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},r=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),o=a(n(0)),i=a(n(1)),c=a(n(8)),u=a(n(9));function a(e){return e&&e.__esModule?e:{default:e}}var f=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.options={url:"wss://www.streamr.com/api/v1/ws",autoConnect:!0,autoDisconnect:!0,authKey:null},n.subsByStream={},n.subById={},n.connection=null,n.connected=!1,Object.assign(n.options,e||{}),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,o.default),r(t,[{key:"_addSubscription",value:function(e){this.subById[e.id]=e,this.subsByStream[e.streamId]?this.subsByStream[e.streamId].push(e):this.subsByStream[e.streamId]=[e]}},{key:"_removeSubscription",value:function(e){delete this.subById[e.id],this.subsByStream[e.streamId]&&(this.subsByStream[e.streamId]=this.subsByStream[e.streamId].filter(function(t){return t!==e}),0===this.subsByStream[e.streamId].length&&delete this.subsByStream[e.streamId])}},{key:"getSubscriptions",value:function(e){return this.subsByStream[e]||[]}},{key:"subscribe",value:function(e,t,n){var r=this;if(!e)throw"subscribe: Invalid arguments: subscription options is required!";if(!t)throw"subscribe: Invalid arguments: callback is required!";if("string"==typeof e)e={stream:e};else if("object"!==(void 0===e?"undefined":s(e)))throw"subscribe: options must be an object";if(Object.assign(e,n),!e.stream)throw"subscribe: Invalid arguments: options.stream is not given";var o=new c.default(e.stream,e.partition||0,e.authKey||this.options.authKey,t,e);return o.on("gap",function(e,t){r._requestResend(o,{resend_from:e,resend_to:t})}),o.on("done",function(){(0,i.default)("done event for sub %d",o.id),r.unsubscribe(o)}),this._addSubscription(o),this.connected?this._resendAndSubscribe(o):this.options.autoConnect&&this.connect(),o}},{key:"unsubscribe",value:function(e){if(!e||!e.streamId)throw"unsubscribe: please give a Subscription object as an argument!";void 0!==this.subsByStream[e.streamId]&&1===this.subsByStream[e.streamId].length&&this.connected&&!this.disconnecting&&e.isSubscribed()&&!e.unsubscribing?(e.unsubscribing=!0,this._requestUnsubscribe(e.streamId)):e.unsubscribing||(this._removeSubscription(e),e.emit("unsubscribed"),this._checkAutoDisconnect())}},{key:"unsubscribeAll",value:function(e){var t=this;if(!e)throw"unsubscribeAll: a stream id is required!";if("string"!=typeof e)throw"unsubscribe: stream id must be a string!";this.subsByStream[e]&&this.subsByStream[e].slice().forEach(function(e){t.unsubscribe(e)})}},{key:"isConnected",value:function(){return this.connected}},{key:"reconnect",value:function(){return this.connect(!0)}},{key:"connect",value:function(){var e=this;if(this.connected)(0,i.default)("connect() called while already connected, doing nothing...");else{if(!this.connecting)return(0,i.default)("Connecting to %s",this.options.url),this.connecting=!0,this.disconnecting=!1,this.connection=new u.default(this.options),this.connection.on("b",function(t){var n=t.streamId,s=e.subsByStream[n];if(s)for(var r=0;r<s.length;r++)s[r].handleMessage(t,!1);else(0,i.default)("WARN: message received for stream with no subscriptions: %s",n)}),this.connection.on("u",function(t,n){void 0!==n&&void 0!==e.subById[n]?e.subById[n].handleMessage(t,!0):(0,i.default)("WARN: subscription not found for stream: %s, sub: %s",t.streamId,n)}),this.connection.on("subscribed",function(t){if(t.error)e.handleError("Error subscribing to "+t.stream+": "+t.error);else{var n=e.subsByStream[t.stream];delete n._subscribing,(0,i.default)("Client subscribed: %o",t),n.filter(function(e){return!e.resending}).forEach(function(e){e.emit("subscribed")})}}),this.connection.on("unsubscribed",function(t){((0,i.default)("Client unsubscribed: %o",t),e.subsByStream[t.stream])&&e.subsByStream[t.stream].slice().forEach(function(t){e._removeSubscription(t),t.emit("unsubscribed")});e._checkAutoDisconnect()}),this.connection.on("resending",function(t){e.subById[t.sub]?e.subById[t.sub].emit("resending",t):(0,i.default)("resent: Subscription %d is gone already",t.sub)}),this.connection.on("no_resend",function(t){e.subById[t.sub]?e.subById[t.sub].emit("no_resend",t):(0,i.default)("resent: Subscription %d is gone already",t.sub)}),this.connection.on("resent",function(t){e.subById[t.sub]?e.subById[t.sub].emit("resent",t):(0,i.default)("resent: Subscription %d is gone already",t.sub)}),this.connection.on("connected",function(){(0,i.default)("Connected!"),e.connected=!0,e.connecting=!1,e.disconnecting=!1,e.emit("connected"),Object.keys(e.subsByStream).forEach(function(t){e.subsByStream[t].forEach(function(t){t.isSubscribed()||e._resendAndSubscribe(t)})})}),this.connection.on("disconnected",function(){(0,i.default)("Disconnected."),e.connected=!1,e.connecting=!1,e.disconnecting=!1,e.emit("disconnected"),Object.keys(e.subsByStream).forEach(function(t){var n=e.subsByStream[t];delete n._subscribing,n.forEach(function(e){e.emit("disconnected")})})}),this.connection.connect(),this.subsByStream;(0,i.default)("connect() called while connecting, doing nothing...")}}},{key:"pause",value:function(){this.connection.disconnect()}},{key:"disconnect",value:function(){var e=this;this.connecting=!1,this.disconnecting=!0,Object.keys(this.subsByStream).forEach(function(t){e.unsubscribeAll(t)}),this.connection.disconnect()}},{key:"_checkAutoDisconnect",value:function(){this.options.autoDisconnect&&0===Object.keys(this.subsByStream).length&&((0,i.default)("Disconnecting due to no longer being subscribed to any streams"),this.disconnect())}},{key:"_resendAndSubscribe",value:function(e){var t=this;e.subscribing||e.resending||(e.subscribing=!0,this._requestSubscribe(e),e.once("subscribed",function(){e.hasResendOptions()&&t._requestResend(e)}))}},{key:"_requestSubscribe",value:function(e){var t=this.subsByStream[e.streamId],n=t.filter(function(e){return e.isSubscribed()});if(t._subscribing||0!==n.length)n.length>0&&((0,i.default)("_requestSubscribe: another subscription for same stream: %s, insta-subscribing",e.streamId),setTimeout(function(){e.emit("subscribed")},0));else{var s=Object.assign({},e.options,{type:"subscribe",stream:e.streamId,authKey:e.authKey});(0,i.default)("_requestSubscribe: subscribing client: %o",s),t._subscribing=!0,this.connection.send(s)}}},{key:"_requestUnsubscribe",value:function(e){(0,i.default)("Client unsubscribing stream %o",e),this.connection.send({type:"unsubscribe",stream:e})}},{key:"_requestResend",value:function(e,t){var n=Object.assign({},e.getEffectiveResendOptions());t&&Object.keys(n).forEach(function(e){e.match(/resend_.*/)&&delete n[e]}),e.resending=!0;var s=Object.assign({},n,t,{type:"resend",stream:e.streamId,partition:e.streamPartition,authKey:e.authKey,sub:e.id});(0,i.default)("_requestResend: %o",s),this.connection.send(s)}},{key:"handleError",value:function(e){(0,i.default)(e),this.emit("error",e)}}]),t}();t.default=f,e.exports=t.default},function(e,t){var n,s,r=e.exports={};function o(){throw new Error("setTimeout has not been defined")}function i(){throw new Error("clearTimeout has not been defined")}function c(e){if(n===setTimeout)return setTimeout(e,0);if((n===o||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:o}catch(e){n=o}try{s="function"==typeof clearTimeout?clearTimeout:i}catch(e){s=i}}();var u,a=[],f=!1,l=-1;function d(){f&&u&&(f=!1,u.length?a=u.concat(a):l=-1,a.length&&b())}function b(){if(!f){var e=c(d);f=!0;for(var t=a.length;t;){for(u=a,a=[];++l<t;)u&&u[l].run();l=-1,t=a.length}u=null,f=!1,function(e){if(s===clearTimeout)return clearTimeout(e);if((s===i||!s)&&clearTimeout)return s=clearTimeout,clearTimeout(e);try{s(e)}catch(t){try{return s.call(null,e)}catch(t){return s.call(this,e)}}}(e)}}function h(e,t){this.fun=e,this.array=t}function p(){}r.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];a.push(new h(e,t)),1!==a.length||f||c(b)},h.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=p,r.addListener=p,r.once=p,r.off=p,r.removeListener=p,r.removeAllListeners=p,r.emit=p,r.prependListener=p,r.prependOnceListener=p,r.listeners=function(e){return[]},r.binding=function(e){throw new Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw new Error("process.chdir is not supported")},r.umask=function(){return 0}},function(e,t,n){function s(e){var n;function s(){if(s.enabled){var e=s,r=+new Date,o=r-(n||r);e.diff=o,e.prev=n,e.curr=r,n=r;for(var i=new Array(arguments.length),c=0;c<i.length;c++)i[c]=arguments[c];i[0]=t.coerce(i[0]),"string"!=typeof i[0]&&i.unshift("%O");var u=0;i[0]=i[0].replace(/%([a-zA-Z%])/g,function(n,s){if("%%"===n)return n;u++;var r=t.formatters[s];if("function"==typeof r){var o=i[u];n=r.call(e,o),i.splice(u,1),u--}return n}),t.formatArgs.call(e,i),(s.log||t.log||console.log.bind(console)).apply(e,i)}}return s.namespace=e,s.enabled=t.enabled(e),s.useColors=t.useColors(),s.color=function(e){var n,s=0;for(n in e)s=(s<<5)-s+e.charCodeAt(n),s|=0;return t.colors[Math.abs(s)%t.colors.length]}(e),s.destroy=r,"function"==typeof t.init&&t.init(s),t.instances.push(s),s}function r(){var e=t.instances.indexOf(this);return-1!==e&&(t.instances.splice(e,1),!0)}(t=e.exports=s.debug=s.default=s).coerce=function(e){return e instanceof Error?e.stack||e.message:e},t.disable=function(){t.enable("")},t.enable=function(e){var n;t.save(e),t.names=[],t.skips=[];var s=("string"==typeof e?e:"").split(/[\s,]+/),r=s.length;for(n=0;n<r;n++)s[n]&&("-"===(e=s[n].replace(/\*/g,".*?"))[0]?t.skips.push(new RegExp("^"+e.substr(1)+"$")):t.names.push(new RegExp("^"+e+"$")));for(n=0;n<t.instances.length;n++){var o=t.instances[n];o.enabled=t.enabled(o.namespace)}},t.enabled=function(e){if("*"===e[e.length-1])return!0;var n,s;for(n=0,s=t.skips.length;n<s;n++)if(t.skips[n].test(e))return!1;for(n=0,s=t.names.length;n<s;n++)if(t.names[n].test(e))return!0;return!1},t.humanize=n(7),t.instances=[],t.names=[],t.skips=[],t.formatters={}},function(e,t){var n=1e3,s=60*n,r=60*s,o=24*r,i=365.25*o;function c(e,t,n){if(!(e<t))return e<1.5*t?Math.floor(e/t)+" "+n:Math.ceil(e/t)+" "+n+"s"}e.exports=function(e,t){t=t||{};var u,a=typeof e;if("string"===a&&e.length>0)return function(e){if((e=String(e)).length>100)return;var t=/^((?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|years?|yrs?|y)?$/i.exec(e);if(!t)return;var c=parseFloat(t[1]);switch((t[2]||"ms").toLowerCase()){case"years":case"year":case"yrs":case"yr":case"y":return c*i;case"days":case"day":case"d":return c*o;case"hours":case"hour":case"hrs":case"hr":case"h":return c*r;case"minutes":case"minute":case"mins":case"min":case"m":return c*s;case"seconds":case"second":case"secs":case"sec":case"s":return c*n;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return c;default:return}}(e);if("number"===a&&!1===isNaN(e))return t.long?c(u=e,o,"day")||c(u,r,"hour")||c(u,s,"minute")||c(u,n,"second")||u+" ms":function(e){if(e>=o)return Math.round(e/o)+"d";if(e>=r)return Math.round(e/r)+"h";if(e>=s)return Math.round(e/s)+"m";if(e>=n)return Math.round(e/n)+"s";return e+"ms"}(e);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(e))}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),r=c(n(0)),o=c(n(1)),i=n(2);function c(e){return e&&e.__esModule?e:{default:e}}var u=0;var a=function(e){function t(e,n,s,r,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var c=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(!e)throw"No stream id given!";if(!r)throw"No callback given!";c.id=(u++).toString(),c.streamId=e,c.streamPartition=n,c.authKey=s,c.callback=r,c.options=i||{},c.queue=[],c.subscribing=!1,c.subscribed=!1,c.lastReceivedOffset=null;var a=0;if(c.options.resend_all&&a++,null!=c.options.resend_from&&a++,null!=c.options.resend_last&&a++,null!=c.options.resend_from_time&&a++,a>1)throw"Multiple resend options active! Please use only one: "+JSON.stringify(i);if(null!=c.options.resend_from_time&&"number"!=typeof c.options.resend_from_time){if("function"!=typeof c.options.resend_from_time.getTime)throw"resend_from_time option must be a Date object or a number representing time!";c.options.resend_from_time=c.options.resend_from_time.getTime()}return c.on("subscribed",function(){(0,o.default)("Sub %s subscribed to stream: %s",c.id,c.streamId),c.subscribed=!0,c.subscribing=!1}),c.on("unsubscribed",function(){(0,o.default)("Sub %s unsubscribed: %s",c.id,c.streamId),c.subscribed=!1,c.subscribing=!1,c.unsubscribing=!1,c.resending=!1}),c.on("resending",function(e){(0,o.default)("Sub %s resending: %o",c.id,e)}),c.on("no_resend",function(e){(0,o.default)("Sub %s no_resend: %o",c.id,e),c.resending=!1,c.checkQueue()}),c.on("resent",function(e){(0,o.default)("Sub %s resent: %o",c.id,e),c.resending=!1,c.checkQueue()}),c.on("connected",function(){}),c.on("disconnected",function(){c.subscribed=!1,c.subscribing=!1,c.resending=!1}),c}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,r.default),s(t,[{key:"handleMessage",value:function(e,t){var n=e.content,s=e.offset,r=e.previousOffset;if(null==r&&(0,o.default)("handleMessage: prevOffset is null, gap detection is impossible! message: %o",e),this.resending&&!t)this.queue.push(e);else if(null!=r&&null!=this.lastReceivedOffset&&r>this.lastReceivedOffset&&!this.resending){this.queue.push(e);var c=this.lastReceivedOffset+1,u=r;(0,o.default)("Gap detected, requesting resend for stream %s from %d to %d",this.streamId,c,u),this.emit("gap",c,u)}else null!=this.lastReceivedOffset&&s<=this.lastReceivedOffset?(0,o.default)("Sub %s already received message: %d, lastReceivedOffset: %d. Ignoring message.",this.id,s,this.lastReceivedOffset):(this.lastReceivedOffset=s,this.callback(n,e),(0,i.isByeMessage)(n)&&this.emit("done"))}},{key:"checkQueue",value:function(){if(this.queue.length){(0,o.default)("Attempting to process %d queued messages for stream %s",this.queue.length,this.streamId);var e=void 0,t=this.queue.length,n=this.queue;for(this.queue=[],e=0;e<t;e++){var s=n[e];this.handleMessage(s,!1)}}}},{key:"hasResendOptions",value:function(){return!0===this.options.resend_all||this.options.resend_from>=0||this.options.resend_from_time>=0||this.options.resend_last>0}},{key:"getEffectiveResendOptions",value:function(){return this.hasReceivedMessages()&&this.hasResendOptions()?this.options.resend_all||this.options.resend_from||this.options.resend_from_time?{resend_from:this.lastReceivedOffset+1}:this.options.resend_last?this.options:void 0:this.options}},{key:"hasReceivedMessages",value:function(){return null!=this.lastReceivedOffset}},{key:"isSubscribed",value:function(){return this.subscribed}}]),t}();t.default=a,e.exports=t.default},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=function(){function e(e,t){for(var n=0;n<t.length;n++){var s=t[n];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}return function(t,n,s){return n&&e(t.prototype,n),s&&e(t,s),t}}(),r=u(n(0)),o=u(n(1)),i=u(n(10)),c=n(2);function u(e){return e&&e.__esModule?e:{default:e}}var a=function(e){function t(e){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));if(!e.url)throw"URL is not defined!";return n.options=e,n.connected=!1,n.connecting=!1,n.disconnecting=!1,e.autoConnect&&n.connect(),n}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,r.default),s(t,[{key:"connect",value:function(){var e=this;this.connected||this.connecting||(this.connecting=!0,this.socket=new i.default(this.options.url),this.socket.binaryType="arraybuffer",this.emit("connecting"),this.socket.onopen=function(){(0,o.default)("Connected to ",e.options.url),e.connected=!0,e.connecting=!1,e.emit("connected")},this.socket.onclose=function(){e.disconnecting?e.disconnecting=!1:((0,o.default)("Connection lost. Attempting to reconnect"),setTimeout(function(){e.connect()},2e3)),e.connected=!1,e.connecting=!1,e.emit("disconnected")},this.socket.onmessage=function(t){var n=(0,c.decodeBrowserWrapper)(t.data);e.emit(n.type,(0,c.decodeMessage)(n.type,n.msg),n.subId)})}},{key:"disconnect",value:function(){void 0!==this.socket&&(this.connected||this.connecting)&&(this.disconnecting=!0,this.socket.close())}},{key:"send",value:function(e){this.socket.send(JSON.stringify(e))}}]),t}();t.default=a,e.exports=t.default},function(e,t,n){"use strict";var s=void 0;s="undefined"!=typeof WebSocket?WebSocket:window.WebSocket,e.exports=s}])});